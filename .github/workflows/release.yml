name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.0)"
        required: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
            npm_package: askuserquestion-darwin-x64
            binary_name: askuserquestion
          - target: aarch64-apple-darwin
            os: macos-latest
            npm_package: askuserquestion-darwin-arm64
            binary_name: askuserquestion
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            npm_package: askuserquestion-linux-x64
            binary_name: askuserquestion
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            npm_package: askuserquestion-linux-arm64
            binary_name: askuserquestion
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            npm_package: askuserquestion-win32-x64
            binary_name: askuserquestion.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libxkbcommon-dev libssl-dev libgtk-3-dev

      - name: Build binary
        working-directory: ask-user-app
        run: cargo build --release --target ${{ matrix.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Copy binary to npm package
        shell: bash
        run: |
          cp ask-user-app/target/${{ matrix.target }}/release/${{ matrix.binary_name }} \
             npm-packages/${{ matrix.npm_package }}/${{ matrix.binary_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.npm_package }}
          path: npm-packages/${{ matrix.npm_package }}/

  publish:
    name: Publish to npm
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC trusted publishing
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Copy binaries to packages and set permissions
        run: |
          for pkg in askuserquestion-darwin-arm64 askuserquestion-darwin-x64 askuserquestion-linux-x64 askuserquestion-linux-arm64 askuserquestion-win32-x64; do
            cp -r artifacts/$pkg/* npm-packages/$pkg/
          done
          # Make Unix binaries executable before npm pack (permissions preserved in tarball)
          chmod +x npm-packages/askuserquestion-darwin-arm64/askuserquestion
          chmod +x npm-packages/askuserquestion-darwin-x64/askuserquestion
          chmod +x npm-packages/askuserquestion-linux-x64/askuserquestion
          chmod +x npm-packages/askuserquestion-linux-arm64/askuserquestion

      - name: Set version from tag or input
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update package versions
        run: |
          cd npm-packages

          # Update all platform packages
          for pkg in askuserquestion-darwin-arm64 askuserquestion-darwin-x64 askuserquestion-linux-x64 askuserquestion-linux-arm64 askuserquestion-win32-x64; do
            cd $pkg
            npm version $VERSION --no-git-tag-version --allow-same-version
            cd ..
          done

          # Update main package and its optionalDependencies
          cd askuserquestion
          npm version $VERSION --no-git-tag-version --allow-same-version
          node -e "
            const pkg = require('./package.json');
            for (const dep of Object.keys(pkg.optionalDependencies)) {
              pkg.optionalDependencies[dep] = '$VERSION';
            }
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      # Publish with OIDC (trusted publishing) if available, fallback to NPM_TOKEN
      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm-packages

          for pkg in askuserquestion-darwin-arm64 askuserquestion-darwin-x64 askuserquestion-linux-x64 askuserquestion-linux-arm64 askuserquestion-win32-x64; do
            cd $pkg
            echo "Publishing @kirmad/$pkg..."
            npm publish --provenance --access public || npm publish --access public || true
            cd ..
          done

      - name: Publish main package
        working-directory: npm-packages/askuserquestion
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing @kirmad/askuserquestion..."
          npm publish --provenance --access public || npm publish --access public
